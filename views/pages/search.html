{{define "search"}}

{{/* 
  IMPORTANT IMPLEMENTATION NOTES:
  - DO NOT USE HTMX for any data requests on this page
  - Use ONLY JSON API endpoints with fetch/Alpine.js for all data operations
  - This page is part of migration away from HTMX to pure JSON API architecture
  - All search functionality must use JSON API endpoints with proper fetch requests
  - Maintain this architecture for any future enhancements to the search functionality
*/}}

<div class="col-span-12 space-y-4" x-data="{
    speciesSearchTerm: '',
    dateRange: {
        start: '',
        end: ''
    },
    confidenceRange: {
        min: 0,
        max: 100
    },
    verifiedStatus: 'any',
    lockedStatus: 'any',
    deviceFilter: '',
    formSubmitted: false,
    advancedFilters: false,
    isLoading: false,
    currentPage: 1,
    totalPages: 1,
    results: [],
    totalResults: 0,
    sortBy: 'date_desc',
    errorMessage: '',
    
    // Form validation methods
    validateForm() {
        // Basic validation logic
        return true;
    },
    
    // Form submission
    async submitSearch(page = 1) {
        if (!this.validateForm()) return;
        
        this.isLoading = true;
        this.errorMessage = '';
        this.currentPage = page;
        
        try {
            const response = await fetch('/api/v2/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name=\'csrf-token\']').content
                },
                body: JSON.stringify({
                    species: this.speciesSearchTerm,
                    dateStart: this.dateRange.start,
                    dateEnd: this.dateRange.end,
                    confidenceMin: this.confidenceRange.min / 100,
                    confidenceMax: this.confidenceRange.max / 100,
                    verifiedStatus: this.verifiedStatus,
                    lockedStatus: this.lockedStatus,
                    page: this.currentPage,
                    sortBy: this.sortBy
                })
            });
            
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            
            const data = await response.json();
            this.results = data.results || [];
            this.totalResults = data.total || 0;
            this.totalPages = data.pages || 1;
            this.formSubmitted = true;
        } catch (error) {
            console.error('Search error:', error);
            this.errorMessage = `Search failed: ${error.message}`;
            this.results = [];
        } finally {
            this.isLoading = false;
        }
    },
    
    // Reset form
    resetForm() {
        this.speciesSearchTerm = '';
        this.dateRange.start = '';
        this.dateRange.end = '';
        this.confidenceRange.min = 0;
        this.confidenceRange.max = 100;
        this.verifiedStatus = 'any';
        this.lockedStatus = 'any';
        this.deviceFilter = '';
        this.formSubmitted = false;
        this.results = [];
        this.errorMessage = '';
    },
    
    // Format date for display
    formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString();
    },
    
    // Handle pagination
    goToPage(page) {
        if (page < 1 || page > this.totalPages) return;
        this.submitSearch(page);
    },
    
    // Handle sorting
    changeSort(sortOption) {
        this.sortBy = sortOption;
        this.submitSearch(1);
    }
}">
    <!-- Search Form -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h2 class="card-title">Search Filters</h2>
            
            <form class="mt-4 space-y-6" @submit.prevent="submitSearch()">
                <!-- Basic Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Species Search -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Species</span>
                        </label>
                        <div class="flex w-full">
                            <input 
                                type="text" 
                                x-model="speciesSearchTerm" 
                                placeholder="Search by species name" 
                                class="input input-bordered w-full"
                            />
                        </div>
                        <label class="label">
                            <span class="label-text-alt">Enter common or scientific name</span>
                        </label>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Date Range</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.start" 
                                    class="input input-bordered w-full" 
                                    placeholder="Start date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">Start date</span>
                                </label>
                            </div>
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.end" 
                                    class="input input-bordered w-full" 
                                    placeholder="End date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">End date</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Toggle -->
                <div class="flex items-center justify-between">
                    <button 
                        type="button"
                        class="btn btn-sm btn-ghost" 
                        @click="advancedFilters = !advancedFilters"
                    >
                        <span x-text="advancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters'"></span>
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            class="h-4 w-4 transition-transform" 
                            :class="{'rotate-180': advancedFilters}"
                            fill="none" 
                            viewBox="0 0 24 24" 
                            stroke="currentColor"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                
                <!-- Advanced Filters Section -->
                <div x-show="advancedFilters" x-transition class="space-y-6">
                    <!-- Confidence Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confidence Range (%)</span>
                            <span class="label-text-alt" x-text="`${confidenceRange.min}% - ${confidenceRange.max}%`"></span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.min" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.max" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Verified Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Verified Status</span>
                            </label>
                            <select x-model="verifiedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="verified">Verified Only</option>
                                <option value="unverified">Unverified Only</option>
                            </select>
                        </div>
                        
                        <!-- Locked Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Locked Status</span>
                            </label>
                            <select x-model="lockedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="locked">Locked Only</option>
                                <option value="unlocked">Unlocked Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                    <button 
                        type="button" 
                        class="btn btn-ghost" 
                        @click="resetForm()"
                    >
                        Reset
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="isLoading"
                    >
                        <template x-if="isLoading">
                            <span class="loading loading-spinner loading-sm mr-2"></span>
                        </template>
                        <template x-if="!isLoading">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </template>
                        Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Area -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title">Search Results</h2>
                
                <!-- Results Count & Sorting (visible when search performed) -->
                <div x-show="formSubmitted" x-transition class="flex items-center gap-4">
                    <span class="text-sm text-base-content/70" x-text="`${totalResults} result${totalResults !== 1 ? 's' : ''}`"></span>
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                            </svg>
                            Sort
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a @click="changeSort('date_desc')">Date (Newest First)</a></li>
                            <li><a @click="changeSort('date_asc')">Date (Oldest First)</a></li>
                            <li><a @click="changeSort('species_asc')">Species (A-Z)</a></li>
                            <li><a @click="changeSort('confidence_desc')">Confidence (High-Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Error message -->
            <div x-show="errorMessage" class="alert alert-error mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span x-text="errorMessage"></span>
            </div>
            
            <!-- When no search performed yet -->
            <div x-show="!formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-base-content/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <p class="text-base-content/50 text-center mt-4">No search performed yet</p>
                <p class="text-base-content/50 text-center text-sm">Use the search filters above to find bird detections</p>
            </div>
            
            <!-- Loading indicator -->
            <div x-show="isLoading && formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-base-content/50 text-center mt-4">Loading results...</p>
            </div>
            
            <!-- Search results table - only visible when search performed -->
            <div x-show="formSubmitted && !isLoading && results.length > 0" x-transition class="overflow-x-auto mt-4">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Species</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(result, index) in results" :key="result.id">
                            <tr>
                                <td x-text="formatDate(result.timestamp)"></td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                                                <span class="text-xs" x-text="result.commonName ? result.commonName.substring(0, 2).toUpperCase() : '--'"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold" x-text="result.commonName || 'Unknown'"></div>
                                            <div class="text-xs opacity-50" x-text="result.scientificName || ''"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center">
                                        <div class="w-16 h-2 rounded-full overflow-hidden bg-base-200">
                                            <div class="h-full" 
                                                 :class="{
                                                    'bg-success': result.confidence >= 0.8,
                                                    'bg-warning': result.confidence >= 0.4 && result.confidence < 0.8,
                                                    'bg-error': result.confidence < 0.4
                                                 }"
                                                 :style="`width: ${result.confidence * 100}%`"></div>
                                        </div>
                                        <span class="ml-2" x-text="`${Math.round(result.confidence * 100)}%`"></span>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex gap-1 flex-wrap">
                                        <div class="status-badge" :class="{
                                            'correct': result.verified === 'correct',
                                            'false': result.verified === 'false_positive',
                                            'unverified': result.verified !== 'correct' && result.verified !== 'false_positive'
                                        }" x-text="result.verified === 'correct' ? 'Verified' : (result.verified === 'false_positive' ? 'False' : 'Unverified')"></div>
                                        <div class="status-badge" :class="{'locked': result.locked, 'unverified': !result.locked}"
                                             x-text="result.locked ? 'Locked' : 'Unlocked'"></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex gap-1">
                                        <button class="btn btn-xs btn-square" @click="window.location.href = `/api/v2/media/audio?id=${result.id}`"
                                                :disabled="!result.hasAudio">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                            </svg>
                                        </button>
                                        <button class="btn btn-xs btn-square" @click="window.location.href = `/api/v2/detections/${result.id}`">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Empty state - when search returns no results -->
            <div x-show="formSubmitted && !isLoading && results.length === 0 && !errorMessage" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="mt-2 text-base-content/70">No results found</p>
                <p class="text-sm text-base-content/50">Try adjusting your search filters</p>
            </div>
            
            <!-- Pagination - visible when results are available -->
            <div x-show="formSubmitted && !isLoading && totalPages > 1" class="flex justify-center mt-6">
                <div class="join">
                    <button class="join-item btn" @click="goToPage(currentPage - 1)" :disabled="currentPage <= 1">«</button>
                    <button class="join-item btn">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></button>
                    <button class="join-item btn" @click="goToPage(currentPage + 1)" :disabled="currentPage >= totalPages">»</button>
                </div>
            </div>
        </div>
    </div>
</div>

{{end}} 