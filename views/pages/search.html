{{define "search"}}

{{/* 
  IMPORTANT IMPLEMENTATION NOTES:
  - DO NOT USE HTMX for any data requests on this page
  - Use ONLY JSON API endpoints with fetch/Alpine.js for all data operations
  - This page is part of migration away from HTMX to pure JSON API architecture
  - All search functionality must use JSON API endpoints with proper fetch requests
  - Maintain this architecture for any future enhancements to the search functionality
*/}}

<div class="col-span-12 space-y-4" x-data="{
    speciesSearchTerm: '',
    dateRange: {
        start: '',
        end: ''
    },
    confidenceRange: {
        min: 0,
        max: 100
    },
    verifiedStatus: 'any',
    lockedStatus: 'any',
    deviceFilter: '',
    formSubmitted: false,
    advancedFilters: false,
    isLoading: false,
    currentPage: 1,
    totalPages: 1,
    results: [],
    totalResults: 0,
    sortBy: 'date_desc',
    errorMessage: '',
    expanded: {},
    
    // Form validation methods
    validateForm() {
        // Basic validation logic
        return true;
    },
    
    // Form submission
    async submitSearch(page = 1) {
        if (!this.validateForm()) return;
        
        this.isLoading = true;
        this.errorMessage = '';
        this.currentPage = page;
        
        try {
            const response = await fetch('/api/v2/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name=\'csrf-token\']').content
                },
                body: JSON.stringify({
                    species: this.speciesSearchTerm,
                    dateStart: this.dateRange.start,
                    dateEnd: this.dateRange.end,
                    confidenceMin: this.confidenceRange.min / 100,
                    confidenceMax: this.confidenceRange.max / 100,
                    verifiedStatus: this.verifiedStatus,
                    lockedStatus: this.lockedStatus,
                    page: this.currentPage,
                    sortBy: this.sortBy
                })
            });
            
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            
            const data = await response.json();
            // Initialize expanded property for each result
            this.results = (data.results || []).map(result => ({
                ...result,
                expanded: false
            }));
            this.totalResults = data.total || 0;
            this.totalPages = data.pages || 1;
            this.formSubmitted = true;
        } catch (error) {
            console.error('Search error:', error);
            this.errorMessage = `Search failed: ${error.message}`;
            this.results = [];
        } finally {
            this.isLoading = false;
        }
    },
    
    // Reset form
    resetForm() {
        this.speciesSearchTerm = '';
        this.dateRange.start = '';
        this.dateRange.end = '';
        this.confidenceRange.min = 0;
        this.confidenceRange.max = 100;
        this.verifiedStatus = 'any';
        this.lockedStatus = 'any';
        this.deviceFilter = '';
        this.formSubmitted = false;
        this.results = [];
        this.errorMessage = '';
    },
    
    // Format date for display
    formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString();
    },
    
    // Handle pagination
    goToPage(page) {
        if (page < 1 || page > this.totalPages) return;
        this.submitSearch(page);
    },
    
    // Handle sorting
    changeSort(sortOption) {
        this.sortBy = sortOption;
        this.submitSearch(1);
    },
    
    toggleExpand(recordId) {
        this.expanded[recordId] = !this.expanded[recordId];
    },
    
    isExpanded(recordId) {
        return this.expanded[recordId] || false;
    },
    
    initAudioPlayer(resultId) {
        const audio = document.getElementById(`audio-${resultId}`);
        const playPauseBtn = document.getElementById(`playPause-${resultId}`);
        const progressBar = document.getElementById(`progress-${resultId}`);
        const progressIndicator = progressBar.querySelector('div');
        const currentTimeDisplay = document.getElementById(`currentTime-${resultId}`);
        const positionIndicator = document.getElementById(`position-indicator-${resultId}`);
        
        if (!audio || !playPauseBtn || !progressBar) return;
        
        // Function to format time in mm:ss
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };
        
        // Play/Pause functionality
        playPauseBtn.addEventListener('click', () => {
            if (audio.paused) {
                // Stop all other audio players first
                document.querySelectorAll('audio').forEach(a => {
                    if (a !== audio && !a.paused) {
                        a.pause();
                        // Reset play button icon for other players
                        const id = a.id.replace('audio-', '');
                        const otherBtn = document.getElementById(`playPause-${id}`);
                        if (otherBtn) {
                            otherBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>`;
                        }
                    }
                });
                
                audio.play();
                playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`;
                
                // Show position indicator
                positionIndicator.style.opacity = '1';
            } else {
                audio.pause();
                playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`;
                
                // Hide position indicator
                positionIndicator.style.opacity = '0';
            }
        });
        
        // Update progress bar and time display
        audio.addEventListener('timeupdate', () => {
            const percent = (audio.currentTime / audio.duration) * 100;
            progressIndicator.style.width = `${percent}%`;
            currentTimeDisplay.textContent = formatTime(audio.currentTime);
            
            // Update position indicator
            if (!audio.paused) {
                positionIndicator.style.left = `${percent}%`;
            }
        });
        
        // Progress bar interaction
        progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pos * audio.duration;
        });
        
        // Handle audio end
        audio.addEventListener('ended', () => {
            playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>`;
            positionIndicator.style.opacity = '0';
        });
    }
}">
    <!-- Search Form -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h2 class="card-title">Search Filters</h2>
            
            <form class="mt-4 space-y-6" @submit.prevent="submitSearch()">
                <!-- Basic Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Species Search -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Species</span>
                        </label>
                        <div class="flex w-full">
                            <input 
                                type="text" 
                                x-model="speciesSearchTerm" 
                                placeholder="Search by species name" 
                                class="input input-bordered w-full"
                            />
                        </div>
                        <label class="label">
                            <span class="label-text-alt">Enter common or scientific name</span>
                        </label>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Date Range</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.start" 
                                    class="input input-bordered w-full" 
                                    placeholder="Start date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">Start date</span>
                                </label>
                            </div>
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.end" 
                                    class="input input-bordered w-full" 
                                    placeholder="End date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">End date</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Toggle -->
                <div class="flex items-center justify-between">
                    <button 
                        type="button"
                        class="btn btn-sm btn-ghost" 
                        @click="advancedFilters = !advancedFilters"
                    >
                        <span x-text="advancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters'"></span>
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            class="h-4 w-4 transition-transform" 
                            :class="{'rotate-180': advancedFilters}"
                            fill="none" 
                            viewBox="0 0 24 24" 
                            stroke="currentColor"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                
                <!-- Advanced Filters Section -->
                <div x-show="advancedFilters" x-transition class="space-y-6">
                    <!-- Confidence Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confidence Range (%)</span>
                            <span class="label-text-alt" x-text="`${confidenceRange.min}% - ${confidenceRange.max}%`"></span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.min" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.max" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Verified Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Verified Status</span>
                            </label>
                            <select x-model="verifiedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="verified">Verified Only</option>
                                <option value="unverified">Unverified Only</option>
                            </select>
                        </div>
                        
                        <!-- Locked Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Locked Status</span>
                            </label>
                            <select x-model="lockedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="locked">Locked Only</option>
                                <option value="unlocked">Unlocked Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                    <button 
                        type="button" 
                        class="btn btn-ghost" 
                        @click="resetForm()"
                    >
                        Reset
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="isLoading"
                    >
                        <template x-if="isLoading">
                            <span class="loading loading-spinner loading-sm mr-2"></span>
                        </template>
                        <template x-if="!isLoading">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </template>
                        Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Area -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title">Search Results</h2>
                
                <!-- Results Count & Sorting (visible when search performed) -->
                <div x-show="formSubmitted" x-transition class="flex items-center gap-4">
                    <span class="text-sm text-base-content/70" x-text="`${totalResults} result${totalResults !== 1 ? 's' : ''}`"></span>
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                            </svg>
                            Sort
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a @click="changeSort('date_desc')">Date (Newest First)</a></li>
                            <li><a @click="changeSort('date_asc')">Date (Oldest First)</a></li>
                            <li><a @click="changeSort('species_asc')">Species (A-Z)</a></li>
                            <li><a @click="changeSort('confidence_desc')">Confidence (High-Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Error message -->
            <div x-show="errorMessage" class="alert alert-error mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span x-text="errorMessage"></span>
            </div>
            
            <!-- When no search performed yet -->
            <div x-show="!formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-base-content/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <p class="text-base-content/50 text-center mt-4">No search performed yet</p>
                <p class="text-base-content/50 text-center text-sm">Use the search filters above to find bird detections</p>
            </div>
            
            <!-- Loading indicator -->
            <div x-show="isLoading && formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-base-content/50 text-center mt-4">Loading results...</p>
            </div>
            
            <!-- Search results table - only visible when search performed -->
            <div x-show="formSubmitted && !isLoading && results.length > 0" x-transition class="overflow-x-auto mt-4">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Species</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(result, index) in results" :key="result.id">
                            <tr>
                                <td x-text="formatDate(result.timestamp)"></td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                                                <span class="text-xs" x-text="result.commonName ? result.commonName.substring(0, 2).toUpperCase() : '--'"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold" x-text="result.commonName || 'Unknown'"></div>
                                            <div class="text-xs opacity-50" x-text="result.scientificName || ''"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center">
                                        <div class="w-16 h-2 rounded-full overflow-hidden bg-base-200">
                                            <div class="h-full" 
                                                 :class="{
                                                    'bg-success': result.confidence >= 0.8,
                                                    'bg-warning': result.confidence >= 0.4 && result.confidence < 0.8,
                                                    'bg-error': result.confidence < 0.4
                                                 }"
                                                 :style="`width: ${result.confidence * 100}%`"></div>
                                        </div>
                                        <span class="ml-2" x-text="`${Math.round(result.confidence * 100)}%`"></span>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex gap-1 flex-wrap">
                                        <div class="status-badge" :class="{
                                            'correct': result.verified === 'correct',
                                            'false': result.verified === 'false_positive',
                                            'unverified': result.verified !== 'correct' && result.verified !== 'false_positive'
                                        }" x-text="result.verified === 'correct' ? 'Verified' : (result.verified === 'false_positive' ? 'False' : 'Unverified')"></div>
                                        <div class="status-badge" :class="{'locked': result.locked, 'unverified': !result.locked}"
                                             x-text="result.locked ? 'Locked' : 'Unlocked'"></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex gap-1">
                                        <button class="btn btn-xs btn-square" @click="window.location.href = `/api/v2/media/audio?id=${result.id}`"
                                                :disabled="!result.hasAudio">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                            </svg>
                                        </button>
                                        <button class="btn btn-xs btn-square" @click="window.location.href = `/api/v2/detections/${result.id}`">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </button>
                                        <button class="btn btn-xs btn-square" @click="toggleExpand(result.id)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" :class="{'rotate-180': isExpanded(result.id)}">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr x-show="isExpanded(result.id)" x-cloak>
                                <td colspan="5" class="p-0">
                                    <div class="p-4 bg-base-200">
                                        <!-- Expanded Information -->
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                            <!-- Audio Player Container -->
                                            <div class="bg-base-200 rounded-box p-4">
                                                <h3 class="text-lg font-semibold mb-2">Audio Player</h3>
                                                <audio :id="'audio-' + result.id" class="hidden" :src="'/api/v2/audio/' + result.id"></audio>
                                                <div class="flex items-center mb-2">
                                                    <button :id="'playPause-' + result.id" class="btn btn-circle btn-sm mr-2">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </button>
                                                    <span :id="'currentTime-' + result.id" class="text-sm">0:00</span>
                                                    <div :id="'progress-' + result.id" class="flex-1 h-2 mx-2 rounded-full bg-gray-700 cursor-pointer">
                                                        <div class="h-full bg-primary rounded-full" style="width: 0%"></div>
                                                    </div>
                                                </div>
                                                <div class="relative">
                                                    <img :src="'/api/v2/spectrogram/' + result.id" alt="Spectrogram" class="w-full h-32 rounded" />
                                                    <div :id="'position-indicator-' + result.id" class="absolute top-0 h-full w-px bg-primary opacity-0 pointer-events-none transition-all"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Weather Information Container -->
                                            <div class="bg-base-200 rounded-box p-4" x-data="{
                                                weather: null,
                                                loading: true,
                                                error: null,
                                                
                                                init() {
                                                    this.fetchWeatherInfo(this.$el.closest('[x-data]').__x.$data.result.id);
                                                },
                                                
                                                fetchWeatherInfo(resultId) {
                                                    fetch(`/api/v2/weather/detection/${resultId}`)
                                                        .then(response => {
                                                            if (!response.ok) {
                                                                throw new Error('Weather data not available');
                                                            }
                                                            return response.json();
                                                        })
                                                        .then(data => {
                                                            this.weather = data;
                                                            this.loading = false;
                                                        })
                                                        .catch(err => {
                                                            console.error('Error fetching weather data:', err);
                                                            this.error = err.message;
                                                            this.loading = false;
                                                        });
                                                }
                                            }">
                                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Weather Information</h3>
                                                
                                                <!-- Loading state -->
                                                <div x-show="loading" class="py-4 flex justify-center">
                                                    <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                </div>
                                                
                                                <!-- Error state -->
                                                <div x-show="!loading && error" class="py-4 text-center text-red-500">
                                                    <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <p x-text="error"></p>
                                                </div>
                                                
                                                <!-- Weather data display -->
                                                <div x-show="!loading && !error && weather" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <!-- Weather conditions -->
                                                    <div class="bg-blue-50 p-3 rounded-lg">
                                                        <h4 class="font-medium text-gray-700 mb-2">Conditions</h4>
                                                        <div class="flex items-center space-x-3">
                                                            <div class="bg-white p-2 rounded-lg shadow-sm">
                                                                <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                                          x-bind:d="weather.conditions.toLowerCase().includes('clear') || weather.conditions.toLowerCase().includes('sun') 
                                                                                    ? 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' 
                                                                                    : 'M3 15a4 4 0 004 4h9a5 5 0 10-4.9-6.001 5.002 5.002 0 00-9.1 2.001z'">
                                                                    </path>
                                                                </svg>
                                                            </div>
                                                            <div>
                                                                <p class="text-2xl font-bold" x-text="Math.round(weather.temperature) + '°C'"></p>
                                                                <p class="text-sm text-gray-600" x-text="weather.conditions"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Time information -->
                                                    <div class="bg-indigo-50 p-3 rounded-lg">
                                                        <h4 class="font-medium text-gray-700 mb-2">Sun Times</h4>
                                                        <div class="space-y-2">
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-yellow-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                                                </svg>
                                                                <span class="text-sm">Sunrise:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="new Date(weather.sunrise * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></span>
                                                            </div>
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                                                                    <circle cx="12" cy="7" r="4"></circle>
                                                                </svg>
                                                                <span class="text-sm">Sunset:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="new Date(weather.sunset * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></span>
                                                            </div>
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                <span class="text-sm">Local time:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="new Date(weather.dt * 1000).toLocaleString()"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Wind and humidity -->
                                                    <div class="bg-green-50 p-3 rounded-lg">
                                                        <h4 class="font-medium text-gray-700 mb-2">Wind & Humidity</h4>
                                                        <div class="space-y-2">
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                                                                </svg>
                                                                <span class="text-sm">Wind:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="Math.round(weather.wind_speed) + ' m/s'"></span>
                                                            </div>
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                                                </svg>
                                                                <span class="text-sm">Humidity:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="weather.humidity + '%'"></span>
                                                            </div>
                                                            <div class="flex items-center">
                                                                <svg class="w-5 h-5 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                                                </svg>
                                                                <span class="text-sm">Pressure:</span>
                                                                <span class="ml-auto text-sm font-medium" x-text="weather.pressure + ' hPa'"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Empty state - when search returns no results -->
            <div x-show="formSubmitted && !isLoading && results.length === 0 && !errorMessage" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="mt-2 text-base-content/70">No results found</p>
                <p class="text-sm text-base-content/50">Try adjusting your search filters</p>
            </div>
            
            <!-- Pagination - visible when results are available -->
            <div x-show="formSubmitted && !isLoading && totalPages > 1" class="flex justify-center mt-6">
                <div class="join">
                    <button class="join-item btn" @click="goToPage(currentPage - 1)" :disabled="currentPage <= 1">«</button>
                    <button class="join-item btn">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></button>
                    <button class="join-item btn" @click="goToPage(currentPage + 1)" :disabled="currentPage >= totalPages">»</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('searchUI', () => ({
            // ... existing code ...
            
            toggleExpand(recordId) {
                this.expanded[recordId] = !this.expanded[recordId];
            },
            
            isExpanded(recordId) {
                return this.expanded[recordId] || false;
            },
            
            initAudioPlayer(resultId) {
                const audio = document.getElementById(`audio-${resultId}`);
                const playPauseBtn = document.getElementById(`playPause-${resultId}`);
                const progressBar = document.getElementById(`progress-${resultId}`);
                const progressIndicator = progressBar.querySelector('div');
                const currentTimeDisplay = document.getElementById(`currentTime-${resultId}`);
                const positionIndicator = document.getElementById(`position-indicator-${resultId}`);
                
                if (!audio || !playPauseBtn || !progressBar) return;
                
                // Function to format time in mm:ss
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                // Play/Pause functionality
                playPauseBtn.addEventListener('click', () => {
                    if (audio.paused) {
                        // Stop all other audio players first
                        document.querySelectorAll('audio').forEach(a => {
                            if (a !== audio && !a.paused) {
                                a.pause();
                                // Reset play button icon for other players
                                const id = a.id.replace('audio-', '');
                                const otherBtn = document.getElementById(`playPause-${id}`);
                                if (otherBtn) {
                                    otherBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>`;
                                }
                            }
                        });
                        
                        audio.play();
                        playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>`;
                        
                        // Show position indicator
                        positionIndicator.style.opacity = '1';
                    } else {
                        audio.pause();
                        playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>`;
                        
                        // Hide position indicator
                        positionIndicator.style.opacity = '0';
                    }
                });
                
                // Update progress bar and time display
                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    progressIndicator.style.width = `${percent}%`;
                    currentTimeDisplay.textContent = formatTime(audio.currentTime);
                    
                    // Update position indicator
                    if (!audio.paused) {
                        positionIndicator.style.left = `${percent}%`;
                    }
                });
                
                // Progress bar interaction
                progressBar.addEventListener('click', (e) => {
                    const rect = progressBar.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audio.currentTime = pos * audio.duration;
                });
                
                // Handle audio end
                audio.addEventListener('ended', () => {
                    playPauseBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                    positionIndicator.style.opacity = '0';
                });
            }
            // ... existing code ...
        }));
    });
</script>

{{end}} 