{{define "detectionfiltersSettings"}}

<!-- Hidden input to always submit the template name -->
<input type="hidden" name="templateName" value="{{.TemplateName}}">

<!-- Privacy Filter start -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3"
     role="region" 
     aria-labelledby="privacyFilterHeader"
     x-data="{ 
    privacyFilter: {
        debug: {{.Settings.Realtime.PrivacyFilter.Debug}},
        enabled: {{.Settings.Realtime.PrivacyFilter.Enabled}},
        confidence: {{.Settings.Realtime.PrivacyFilter.Confidence}}
    },
    filteringSettingsOpen: false,
    showTooltip: null,
    hasChanges: false,
    resetChanges() {
        this.hasChanges = false;
    }
}"
x-init="
    $watch('privacyFilter', () => { hasChanges = true }, { deep: true });
">

    <!-- control collapse element open state and label visibility -->
    <input type="checkbox" id="privacyFilterSettingsOpen"
        x-on:change="filteringSettingsOpen = !filteringSettingsOpen"
        aria-controls="privacyFilterSettingsContent"
        aria-expanded="true" />

    {{template "sectionHeader" dict
        "id" "privacyFilter"
        "title" "Privacy Filtering"
        "description" "Privacy filtering avoids saving audio clips when human vocals are detected"}}

    <div class="collapse-content"
         id="privacyFilterSettingsContent"
         role="group" 
         aria-labelledby="privacyFilterDescription">

        {{template "checkbox" dict
            "id" "privacyFilterEnabled"
            "model" "privacyFilter.enabled"
            "name" "realtime.privacyfilter.enabled"
            "label" "Enable Privacy Filtering"
            "tooltip" "Enables detection of human voices, if detected discards bird detection to protect privacy"}}

        <div x-show="privacyFilter.enabled"
             id="privacyFilterOptionsGroup"
             role="group"
             aria-label="Privacy Filter Additional Settings">
            
            {{template "numberField" dict
                "id" "privacyFilterConfidence"
                "model" "privacyFilter.confidence"
                "name" "realtime.privacyFilter.confidence"
                "label" "Confidence Threshold for Human Detection"
                "step" "0.01"
                "min" "0"
                "max" "1"
                "tooltip" "Set the confidence level for human voice detection, lower value makes filter more sensitive"}}

        </div>
    </div>
</div>
<!-- Privacy Filter end -->

<!-- Dog Bark Filter start -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3"
     role="region" 
     aria-labelledby="dogBarkFilterHeader"
     x-data="{ 
    dogBarkFilter: {
        debug: {{.Settings.Realtime.DogBarkFilter.Debug}},
        enabled: {{.Settings.Realtime.DogBarkFilter.Enabled}},
        confidence: {{.Settings.Realtime.DogBarkFilter.Confidence}},
        remember: {{.Settings.Realtime.DogBarkFilter.Remember}},
        species: {{.Settings.Realtime.DogBarkFilter.Species | toJSON}} || [],
    },
    newSpecies: '',
    editIndex: null,
    editSpecies: '',
    filteringSettingsOpen: false,
    showTooltip: null,
    hasChanges: false,
    predictions: [],
    allowedSpecies: {{getIncludedSpecies | toJSON}},
    resetChanges() {
        this.hasChanges = false;
    },
    addSpecies() {
        if (!this.dogBarkFilter.species) {
            this.dogBarkFilter.species = [];
        }
        if (this.newSpecies.trim()) {
            this.dogBarkFilter.species.push(this.newSpecies.trim());
            this.newSpecies = '';
            this.hasChanges = true;
            this.predictions = [];
        }
    },
    removeSpecies(index) {
        this.dogBarkFilter.species.splice(index, 1);
        this.hasChanges = true;
    },
    startEdit(index) {
        this.editIndex = index;
        this.editSpecies = this.dogBarkFilter.species[index];
    },
    saveEdit() {
        if (this.editSpecies.trim()) {
            this.dogBarkFilter.species[this.editIndex] = this.editSpecies.trim();
            this.editIndex = null;
            this.editSpecies = '';
            this.hasChanges = true;
        }
    },
    cancelEdit() {
        this.editIndex = null;
        this.editSpecies = '';
    },
    updatePredictions() {
        if (!this.allowedSpecies || this.allowedSpecies.length === 0) {
            this.predictions = [];
            return;
        }

        const input = this.newSpecies.toLowerCase();
        this.predictions = this.allowedSpecies
            .filter(species => species.toLowerCase().includes(input))
            .slice(0, 5); // limit to 5 suggestions
    }
}" x-init="
    $watch('dogBarkFilter', () => { hasChanges = true }, { deep: true });
">
    <!-- control collapse element open state and label visibility -->
    <input type="checkbox" id="dogBarkFilterSettingsOpen"
        x-on:change="filteringSettingsOpen = !filteringSettingsOpen"
        aria-controls="dogBarkFilterSettingsContent"
        aria-expanded="true" />

    {{template "sectionHeader" dict
        "id" "dogBarkFilter"
        "title" "False Positive Prevention"
        "description" "Configure false detection filters"}}

    <div class="collapse-content"
         id="dogBarkFilterSettingsContent"
         role="group" 
         aria-labelledby="dogBarkFilterDescription">
        
        {{template "checkbox" dict
            "id" "dogBarkFilterEnabled"
            "model" "dogBarkFilter.enabled"
            "name" "realtime.dogbarkfilter.enabled"
            "label" "Enable Dog Bark Filter"
            "tooltip" "Filters out dog barks to reduce false positives in bird detection."}}

        <div x-show="dogBarkFilter.enabled"
             id="dogBarkFilterOptionsGroup"
             role="group"
             aria-label="Dog Bark Filter Additional Settings">
            
            {{template "numberField" dict
                "id" "dogBarkFilterConfidence"
                "model" "dogBarkFilter.confidence"
                "name" "realtime.dogbarkfilter.confidence"
                "label" "Confidence Threshold"
                "step" "0.01"
                "min" "0"
                "max" "1"
                "tooltip" "Set the confidence level for dog bark detection, lower value makes filter more sensitive"}}

            {{template "numberField" dict
                "id" "dogBarkFilterRemember"
                "model" "dogBarkFilter.remember"
                "name" "realtime.dogbarkfilter.remember"
                "label" "Dog Bark Expire Time (Minutes)"
                "min" "0"
                "tooltip" "Set how long to remember a detected dog bark"}}

        </div>

        <!-- Dog Bark Species List -->
        <div class="form-control mt-6" x-show="dogBarkFilter.enabled"
             id="dogBarkSpeciesList"
             role="group"
             aria-label="Dog Bark Species List">
            <label class="label justify-start">
                <span class="label-text">Dog Bark Species List</span>
                <span class="help-icon"
                      @mouseenter="showTooltip = 'dogBarkSpecies'"
                      @mouseleave="showTooltip = null">â“˜</span>
            </label>
            <div x-show="showTooltip === 'dogBarkSpecies'" x-cloak class="tooltip">
                List of species to filter out as potential dog barks
            </div>

            <!-- Dog Bark Species List -->
            <div class="space-y-2">
                <template x-for="(species, index) in dogBarkFilter.species" :key="index">
                    <div class="settings-list-item">
                        <div class="flex-grow">
                            <span x-show="editIndex !== index" 
                                  @click="startEdit(index)" 
                                  x-text="species"
                                  class="text-sm cursor-pointer hover:underline"></span>
                            <input x-show="editIndex === index" 
                                   x-model="editSpecies" 
                                   @keyup.enter="saveEdit"
                                   @keyup.escape="cancelEdit"
                                   class="input input-sm input-bordered w-full" />
                        </div>
                        <div class="flex-shrink-0">
                            <div class="btn-group">
                                <button type="button" @click="saveEdit" 
                                        x-show="editIndex === index" 
                                        class="btn btn-xs">Save</button>
                                <button type="button" @click="cancelEdit" 
                                        x-show="editIndex === index" 
                                        class="btn btn-xs">Cancel</button>
                                <button type="button" @click="removeSpecies(index)" 
                                        class="btn btn-xs">Remove</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Add New Species -->
            <div class="settings-input-group">
                <input type="text" 
                       x-model="newSpecies" 
                       @input="updatePredictions()" 
                       list="species-suggestions"
                       placeholder="Add new species">
                <datalist id="species-suggestions">
                    <template x-for="suggestion in predictions" :key="suggestion">
                        <option :value="suggestion"></option>
                    </template>
                </datalist>
                <button type="button" @click="addSpecies()">Add</button>
            </div>
            <input type="hidden" name="realtime.dogbarkfilter.species" :value="JSON.stringify(dogBarkFilter.species)" />
        </div>
    </div>
</div>
<!-- Dog Bark Filter end -->

{{end}}