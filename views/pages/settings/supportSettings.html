{{define "supportSettings"}}

<!-- Hidden input to always submit the template name -->
<input type="hidden" name="templateName" value="{{.TemplateName}}">

<!-- Sentry Telemetry Settings start -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3" 
     role="region" 
     aria-labelledby="sentryHeader"
     x-data="{ 
    sentry: {
        enabled: {{.Settings.Sentry.Enabled}}
    },
    sentrySettingsOpen: false,
    showTooltip: null,
    hasChanges: false,
    resetChanges() {
        this.hasChanges = false;
    }
}" x-init="
    $watch('sentry', (value) => { hasChanges = true }, { deep: true });
">

    <!-- control collapse element open state and label visibility -->
    <input type="checkbox" 
           id="sentrySettingsOpen" 
           x-on:change="sentrySettingsOpen = !sentrySettingsOpen" 
           aria-controls="sentrySettingsContent"
           aria-expanded="true" />

    {{template "sectionHeader" dict
        "id" "sentry"
        "title" "Error Tracking & Telemetry"
        "description" "Optional error tracking to help improve BirdNET-Go reliability and performance"}}

    <div class="collapse-content"
         id="sentrySettingsContent"
         role="group" 
         aria-labelledby="sentryDescription">

        <!-- Privacy Notice -->
        <div class="alert alert-info mb-4 shadow-sm" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
                <h3 class="font-bold">Privacy-First Error Tracking</h3>
                <div class="text-sm mt-1">
                    <p>Error tracking is <strong>completely optional</strong> and requires your explicit consent. When enabled:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Only essential error information is collected for debugging</li>
                        <li>No personal data, audio recordings, or bird detection data is sent</li>
                        <li>All data is filtered to remove sensitive information</li>
                        <li>Telemetry data helps developers identify and fix issues in BirdNET-Go</li>
                    </ul>
                </div>
            </div>
        </div>

        {{template "checkbox" dict
            "id" "sentryEnabled"
            "model" "sentry.enabled"
            "name" "sentry.enabled"
            "label" "Enable Error Tracking (Opt-in)"
            "tooltip" "Enable privacy-compliant error tracking to help improve BirdNET-Go. Only essential technical information is collected."}}

        <!-- System ID Display (always visible) -->
        <div class="form-control w-full mt-4" role="group">
            <label class="label" for="systemID">
                <span class="label-text">Your System ID</span>
                <div class="tooltip" data-tip="This unique identifier helps developers track errors from your system. Share this ID when reporting issues on GitHub if you want your telemetry data to be identifiable for debugging.">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </label>
            <div class="join">
                <input type="text" id="systemID" value="{{.Settings.SystemID}}" class="input input-bordered join-item w-full font-mono" readonly />
                <button type="button" class="btn join-item" onclick="navigator.clipboard.writeText('{{.Settings.SystemID}}').then(() => { 
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'Copied!';
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-success');
                    }, 2000);
                })">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copy
                </button>
            </div>
            <label class="label">
                <span class="label-text-alt text-neutral-content">Include this ID when reporting issues if you want developers to identify your error reports</span>
            </label>
        </div>

        <div x-show="sentry.enabled"
             class="grid grid-cols-1 gap-4 mt-4"
             id="sentrySettings"
             role="group"
             aria-label="Sentry Configuration">

            <!-- Setup Instructions -->
            <div class="alert alert-success" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <div>
                    <h3 class="font-bold">Error Tracking Enabled</h3>
                    <div class="text-sm mt-1">
                        <p>BirdNET-Go will now automatically report errors to help developers identify and fix issues in BirdNET-Go.</p>
                        <p class="mt-2">Your errors will be tagged with your System ID shown above.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Sentry Telemetry Settings end -->

<!-- Support Tools -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3" 
     role="region" 
     aria-labelledby="supportToolsHeader"
     x-data="{ 
        supportOpen: false,
        generating: false,
        uploadProgress: false,
        supportDump: {
            includeLogs: true,
            includeConfig: true,
            includeSystemInfo: true,
            userMessage: '',
            uploadToSentry: false
        },
        generateSupportDump() {
            this.generating = true;
            
            // Build form data
            const formData = new FormData();
            formData.append('include_logs', this.supportDump.includeLogs);
            formData.append('include_config', this.supportDump.includeConfig);
            formData.append('include_system_info', this.supportDump.includeSystemInfo);
            formData.append('user_message', this.supportDump.userMessage);
            formData.append('upload_to_sentry', this.supportDump.uploadToSentry);
            
            fetch('/api/v1/support/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                this.generating = false;
                if (data.success) {
                    if (data.download_url) {
                        // Download the file
                        window.location.href = data.download_url;
                    }
                    // Show success notification (will be handled by SSE)
                } else {
                    alert('Failed to generate support dump: ' + data.message);
                }
            })
            .catch(error => {
                this.generating = false;
                alert('Error generating support dump: ' + error);
            });
        }
    }">

    <!-- control collapse element open state and label visibility -->
    <input type="checkbox" 
           id="supportToolsOpen" 
           x-on:change="supportOpen = !supportOpen"
           aria-controls="supportToolsContent"
           aria-expanded="true" />

    {{template "sectionHeader" dict
        "id" "supportTools"
        "title" "Support & Diagnostics"
        "description" "Generate diagnostic reports for troubleshooting and support"}}

    <div class="collapse-content"
         id="supportToolsContent"
         role="group" 
         aria-labelledby="supportToolsDescription">

        <!-- Support Dump Generation -->
        <div class="card bg-base-200">
            <div class="card-body">
                <h3 class="card-title text-lg">Generate Support Report</h3>
                <p class="text-sm text-base-content/70 mb-4">
                    Create a diagnostic report containing system information, logs, and configuration (with sensitive data removed).
                </p>

                <!-- Options -->
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" x-model="supportDump.includeLogs" class="checkbox checkbox-primary" />
                            <span class="label-text">Include recent logs</span>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" x-model="supportDump.includeConfig" class="checkbox checkbox-primary" />
                            <span class="label-text">Include configuration (sensitive data removed)</span>
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" x-model="supportDump.includeSystemInfo" class="checkbox checkbox-primary" />
                            <span class="label-text">Include system information</span>
                        </label>
                    </div>

                    <!-- User Message -->
                    <div class="form-control">
                        <label class="label" for="userMessage">
                            <span class="label-text">Describe the issue (optional)</span>
                        </label>
                        <textarea 
                            id="userMessage"
                            x-model="supportDump.userMessage" 
                            class="textarea textarea-bordered h-24" 
                            placeholder="Please describe what issue you're experiencing..."></textarea>
                    </div>

                    <!-- Upload Option (only shown if telemetry is enabled) -->
                    <div x-show="{{.Settings.Sentry.Enabled}}" class="form-control">
                        <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" x-model="supportDump.uploadToSentry" class="checkbox checkbox-primary" />
                            <span class="label-text">Upload to developers (via secure telemetry)</span>
                        </label>
                        <label class="label">
                            <span class="label-text-alt text-warning">⚠️ Only enable if you want to share this data with developers</span>
                        </label>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="card-actions justify-end mt-6">
                    <button 
                        @click="generateSupportDump()"
                        :disabled="generating || (!supportDump.includeLogs && !supportDump.includeConfig && !supportDump.includeSystemInfo)"
                        class="btn btn-primary">
                        <span x-show="!generating" class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                            </svg>
                            <span x-text="supportDump.uploadToSentry ? 'Generate & Upload' : 'Generate & Download'"></span>
                        </span>
                        <span x-show="generating" class="loading loading-spinner"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="alert alert-info mt-4" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
                <h3 class="font-bold">Privacy Notice</h3>
                <div class="text-sm mt-1">
                    <p>Support reports are designed to protect your privacy:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Passwords, API keys, and tokens are automatically removed</li>
                        <li>No audio recordings or bird detection data is included</li>
                        <li>System paths and hostnames are anonymized</li>
                        <li>Reports are only uploaded if you explicitly choose to do so</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{{end}}