name: Test Failure Monitor

on:
  workflow_run:
    workflows: ["golangci-test"]
    types:
      - completed

jobs:
  create-issue-on-failure:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: read
    steps:
      - name: Check if issue already exists
        id: check-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing open test failure issues
          EXISTING_ISSUE=$(gh issue list --repo ${{ github.repository }} --state open --label "test-failure" --limit 1 --json number --jq '.[0].number // empty')
          if [[ -n "$EXISTING_ISSUE" ]]; then
            echo "existing_issue=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
            echo "Found existing test failure issue: #$EXISTING_ISSUE"
          else
            echo "existing_issue=" >> $GITHUB_OUTPUT
            echo "No existing test failure issue found"
          fi

      - name: Create test failure issue
        if: steps.check-issue.outputs.existing_issue == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "ðŸ”´ Unit Tests Failing - Automated Fix Needed" \
            --label "test-failure,automated" \
            --body "@claude Please analyze and fix the failing unit tests.

          ## Test Failure Details
          - **Workflow Run**: ${{ github.event.workflow_run.html_url }}
          - **Commit**: ${{ github.event.workflow_run.head_sha }}
          - **Branch**: ${{ github.event.workflow_run.head_branch }}
          - **Triggered by**: ${{ github.event.workflow_run.triggering_actor.login }}
          
          ## Instructions for Claude
          Please:
          1. Download and analyze the test logs from the failed workflow
          2. Identify the root cause of test failures
          3. Implement fixes following project guidelines in CLAUDE.md
          4. Create a PR with the fixes
          5. Verify all tests pass after your changes
          
          ## Guidelines
          - Use internal/errors package for error handling
          - Follow modern Go patterns (no time.Sleep in tests)
          - Use t.TempDir() for temporary directories  
          - Run golangci-lint before finalizing
          - Only fix failing tests, don't modify working ones"

      - name: Comment on existing issue
        if: steps.check-issue.outputs.existing_issue != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.check-issue.outputs.existing_issue }} \
            --repo ${{ github.repository }} \
            --body "ðŸ”„ **New Test Failure Detected**

          - **Workflow Run**: ${{ github.event.workflow_run.html_url }}
          - **Commit**: ${{ github.event.workflow_run.head_sha }}
          - **Branch**: ${{ github.event.workflow_run.head_branch }}
          
          @claude Please analyze this latest test failure and provide fixes."